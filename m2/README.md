# Active Directory med Powershell

GIT REPOET FOR DENNE PORTEFOLIEN ER: https://gitlab.stud.idi.ntnu.no/erkis/dcsg1005-m2

[[_TOC_]]

## Målet med prosjektet
Målet med dette prosjektet var å lage en Active-Directory infrastruktur som i følge casebeskrivelsen skal settes opp for en bedrift. Denne infrastrukturen skal inneholde flere OUer, altså Organizational Units, som skal inneholde datamaskiner, security groups og totalt 41 brukere delt opp i fem forskjellige arbeidsposisjoner. Alle av disse forenevnte skal også få tildelt rettigheter for å bruke deler av infrastrukturen som tilhører dem, som for eksempel adgangskort for alle, eller printere for alle utenom renhold.  


## Design / Løsning
Jeg prøvde å lage så mye som mulig via powershell, slik at den kjøres automatisk uten større krav for bruk av GUIen for å sette opp Active Directory. Jeg ville også få scriptet til å være så kort som mulig, og brukte derfor så mange variabler og loops (for det meste Foreach-Object) som mulig. Slike loops hjelper også med scriptet til å se mye bedre ut, men med tanke på casebeskrivelsen, er det nok ikke et problem. Først når jeg begynte, prøvde jeg å sette sammen hele scriptet i kun et script som kjører alle commands i ett. Uheldigvis, når jeg brukte Enter-PSSEssion kommandoen, fikk jeg en varsling om at jeg må tillate kobling mellom domain controller og serveren, som så ut til å være på en manuell måte. Derfor valgte jeg å heller dele opp scriptet slik at de kan kjøres på hver sin maskin. Dette hadde hjulpet meg med oppsettet av overvåkningen som jeg dessverre ikke fikk tid til å lage. Overvåkningsscriptet hadde blitt satt opp rett på serveren, slik at den ikke kjører i DC1 sin konsoll, men heller i SRV1.

Hele oppsettet av scriptet er tydelig basert på Tor Ivar sitt eksempel fra tips og triks vist på [video nr 1](https://www.youtube.com/watch?v=XYtoVALkMao), [video nr 2](https://www.youtube.com/watch?v=mjiHhYRSEtQ), og [selve koden](https://gitlab.com/undervisning/dcst1005-demo/-/blob/master/Uke_9-Active_Directory-TIPSnTRICK-Mappe2.ps1). Jeg har jobbet med å automatisere den enda mer, slik at scriptet er både lettere å bruke, og ikke like stort (med tanke på hvordan den hadde vært hvis den inneholdt alle mapper osv.). Naturligvis, baserte jeg også AD-strukturen på det eksempelet, siden det virket som en god generell løsning. Brukere blir delt i en mappe som inneholder mapper laget for deres jobbtittel. Det samme gjøres med maskinene, som da deles opp til server og arbeidsstasjoner. Til slutt er det en mappe for ressurser som inneholder tilgang til adgangskort og printere etter at de kobles til (eller brukerne blir en del av) brukerne.

For å sette IIS som default start page i Internet Explorer i klienten, brukte jeg Group Policy Manager. Der laget jeg en ny GPO for akkurat dette med default start page. For å bestemme denne siden, trykket jeg på "Edit" på GPOen og fant meg fram til "Disable changing home page settings" under Internet Explorer. Deretter trykket jeg på "Enabled" for å skru på innstillingen, og skreiv inn "http://srv1/" som "Home Page". Dette her blir nærmere forklart [her,](https://www.avoiderrors.com/set-internet-explorer-homepage-using-gpo/) hvis forklaringen var litt uklar.

Når det kom til spørsmålet om noen andre brukere enn IT Administratorer skal kunne logge på konsollet på en server, er svaret nei. Det er fordi IT Administratorene er de som har ansvaret for å vedlikeholde serveren, mens de andre, som for eksempel utviklerne, eller developers, har sine egne arbeidsoppgaver som utvikling og koding av prosjektet sitt. Det har også litt med sikkerheten å gjøre. Ikke kun troverdigheten av arbeiderne, men også evnene deres. Noen som er spesialisert innen regnskap er mest sannsynlig ikke like utdannet på å vedlikeholde en server som noen som har jobbet med det mye lenger. Jeg delte opp rettighetene for disse sikkerhetsgruppene slik at alle arbeidere får kun tilgang til ressurser som de burde få tilgang til. Det er for eksempel ingen grunn for en som jobber med renhold å bruke printeren, mens de andre som jobber der, trenger det. Men alle trenger adgangskort, og derfor er alle en del av denne sikkerhetsgruppen.

For å sette opp GPOer, gjorde jeg det som sagt manuelt via Group Policy Management på Domain Controlleren. For å la bedriftens ansatte bruke Remote Desktop til sine laptoper, brukte jeg [denne videoen av Tor Ivar](https://www.youtube.com/watch?v=qaInjvotF_M) som framgangsmåte. Jeg laget denne GPOen som vist i videoen, og koblet det til brukerne inne i Active Directory. 

For logging av nye brukere brukte jeg [notater fra en tidligere undervisning](https://gitlab.com/erikhje/dcsg1005/-/blob/master/logging-monitoring/notes.md) som kilde.

## Diskusjon, og om sikkerhet
Det største scriptet lager hele infrastrukturen i domain controlleren uten noen problemer som jeg har merket (utenom konflikt med password requirements på noen brukere som lett kan endres på). Det lager alle mapper, brukere, ressurser, og security groups og legger dem der de skal være. Når det kom til server-siden av oppgaven, begynte noen problemer å dukke opp. Det største problemet var at "\\sec.core\" (og andre undermapper som files) ikke eksisterte av en eller annen grunn. Det tok vekk mulighetene for å teste noen deler av oppgaven som for eksempel delen med ACL og rettigheter. Jeg prøvde å følge eksempelet til Tor Ivar så mye som mulig, slik at scriptet i hvert fall ble ferdig og hadde vært brukelig, hadde alt fungert som det skal. 

Jeg prøvde også å følge andre eksempler fra Tor Ivar sin [gitlab side](https://gitlab.com/undervisning/dcst1005-demo/-/tree/master), spesielt fra [configure-dfs-namespace.ps1](https://gitlab.com/undervisning/dcst1005-demo/-/blob/master/configure-dfs-namespace.ps1), som så ut til å være koblet til DFS som ble brukt for rettigheter og så videre. Uheldigvis fant jeg ikke problemet etter dette heller.

Når det kommer til sikkerhet, ser jeg ikke noen store problemer med sikkerhet inni selve scriptet, siden den lager kun et AD-infrastruktur som bestemmes av scriptet. Et script gir også rettigheter til brukere, men disse settes selv av scriptet, slik at alle får rettigheter til det de skal ha rettigheter til. Dette er altså tilfellet hvis scriptet er satt opp riktig.

## Konklusjon og refleksjon
Som konklusjon, tror jeg at jeg har laget et ganske greit script for å sette opp infrastrukturen, siden den bruker så mange loops som jeg kunne se for meg. Den andre delen av scriptet gikk ikke like bra, mest på grunn av problemer med selve Active Directory som enten ikke fungerte som det skal, eller var satt opp feil. Jeg satser på at feilen lå i AD, siden jeg fulgte tipsene til Tor Ivar. Sammenlignet med forrige mappeoppgave, var denne mye vanskeligere, og krevde mye mer testing og sletting. Hadde jeg visst dette, hadde jeg brukt tiden min mye bedre, siden jeg føler at jeg ikke brukte den på den beste måten. Heldigvis gikk ganske mange deler av oppgaven greit, og forhåpentligvis har denne oppgaven vært en god opplæring for meg for neste mappeoppgave.
